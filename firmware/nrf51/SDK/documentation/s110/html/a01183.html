<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.3.1"/>
<title>nRF51 SDK - S110 SoftDevice: Init packet handling in DFU.</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="nordic_small.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">nRF51 SDK - S110 SoftDevice
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.3.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Home</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>API&#160;Reference</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('a01183.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#nested-classes">Data Structures</a> &#124;
<a href="#define-members">Macros</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">Init packet handling in DFU.<div class="ingroups"><a class="el" href="a01279.html">Bootloader/DFU API</a></div></div>  </div>
</div><!--header-->
<div class="contents">

<p>Device Firmware Update module type and function declaration for init packet handling.  
<a href="#details">More...</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="nested-classes"></a>
Data Structures</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00405.html">dfu_init_packet_t</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">Structure contained in an init packet. Contains information on device type, revision, and supported SoftDevices.  <a href="a00405.html#details">More...</a><br/></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00404.html">dfu_device_info_t</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">Structure holding basic device information settings.  <a href="a00404.html#details">More...</a><br/></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:ga7dbc00b26886d263bc3ff6fed3314df0"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a01183.html#ga7dbc00b26886d263bc3ff6fed3314df0">UICR_CUSTOMER_DEVICE_INFO_OFFSET</a>&#160;&#160;&#160;0x0</td></tr>
<tr class="separator:ga7dbc00b26886d263bc3ff6fed3314df0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gaf398722d5fa37c34e7e1554a4c23b31f"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a01183.html#gaf398722d5fa37c34e7e1554a4c23b31f">UICR_CUSTOMER_RESERVED_OFFSET</a>&#160;&#160;&#160;0x80</td></tr>
<tr class="separator:gaf398722d5fa37c34e7e1554a4c23b31f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gacdac816b4730617eedc86394ca32f145"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a01183.html#gacdac816b4730617eedc86394ca32f145">DFU_DEVICE_INFO_BASE</a></td></tr>
<tr class="separator:gacdac816b4730617eedc86394ca32f145"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga0739b7c5c51d4dd06d88df8fb562e186"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a01183.html#ga0739b7c5c51d4dd06d88df8fb562e186">DFU_DEVICE_INFO</a>&#160;&#160;&#160;((<a class="el" href="a00404.html">dfu_device_info_t</a> *)<a class="el" href="a01183.html#gacdac816b4730617eedc86394ca32f145">DFU_DEVICE_INFO_BASE</a>)</td></tr>
<tr class="separator:ga0739b7c5c51d4dd06d88df8fb562e186"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gaa80004af35800b51c972eb5441641b02"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a01183.html#gaa80004af35800b51c972eb5441641b02">DFU_DEVICE_TYPE_EMPTY</a>&#160;&#160;&#160;((uint16_t)0xFFFF)</td></tr>
<tr class="separator:gaa80004af35800b51c972eb5441641b02"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gab5e1b5ab912c1a30149be52c8cea371d"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a01183.html#gab5e1b5ab912c1a30149be52c8cea371d">DFU_DEVICE_REVISION_EMPTY</a>&#160;&#160;&#160;((uint16_t)0xFFFF)</td></tr>
<tr class="separator:gab5e1b5ab912c1a30149be52c8cea371d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga963498faf6af23086555c594504b4152"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a01183.html#ga963498faf6af23086555c594504b4152">DFU_SOFTDEVICE_ANY</a>&#160;&#160;&#160;((uint16_t)0xFFFE)</td></tr>
<tr class="separator:ga963498faf6af23086555c594504b4152"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:ga585131c480f3f4e51293e954b4c26aeb"><td class="memItemLeft" align="right" valign="top">uint32_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a01183.html#ga585131c480f3f4e51293e954b4c26aeb">dfu_init_prevalidate</a> (uint8_t *p_init_data, uint32_t init_data_len)</td></tr>
<tr class="memdesc:ga585131c480f3f4e51293e954b4c26aeb"><td class="mdescLeft">&#160;</td><td class="mdescRight">DFU prevalidate call for pre-checking the received init packet.  <a href="#ga585131c480f3f4e51293e954b4c26aeb">More...</a><br/></td></tr>
<tr class="separator:ga585131c480f3f4e51293e954b4c26aeb"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga1926c2d8e3484641d16f9beb654ac5f1"><td class="memItemLeft" align="right" valign="top">uint32_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a01183.html#ga1926c2d8e3484641d16f9beb654ac5f1">dfu_init_postvalidate</a> (uint8_t *p_image, uint32_t image_len)</td></tr>
<tr class="memdesc:ga1926c2d8e3484641d16f9beb654ac5f1"><td class="mdescLeft">&#160;</td><td class="mdescRight">DFU postvalidate call for post-checking the received image using the init packet.  <a href="#ga1926c2d8e3484641d16f9beb654ac5f1">More...</a><br/></td></tr>
<tr class="separator:ga1926c2d8e3484641d16f9beb654ac5f1"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<p>Device Firmware Update module type and function declaration for init packet handling. </p>
<p>This header contains basic functionality for performing safety checks on software updates for nRF51 based devices. It provides a skeleton for pre-checking an init packet to ensure the following image is compatible with this device. A safety check should always be performed to prevent accidental flashing of unsupported applications or a wrong combination of application and SoftDevice. The device information contains information such as:</p>
<ul>
<li>Device type (2 bytes), for example Heart Rate. The device type is a number defined by the customer. It can be located in UICR or FICR.</li>
<li>Device revision (2 bytes), for example major revision 1, minor revision 0. The device revision is a number defined by the customer. It can be located in UICR or FICR.</li>
<li>List of SoftDevices supported by this application, for example 0x0049 = S110v6_0_0 0xFFFE = S110 development (any SoftDevice accepted),</li>
<li>CRC or hash of firmware image</li>
</ul>
<dl class="section note"><dt>Note</dt><dd>This module does not support security features such as image signing, but the corresponding implementation allows for such extensions. If the init packet is signed by a trusted source, it must be decrypted before it can be processed. </dd></dl>
<h2 class="groupheader">Macro Definition Documentation</h2>
<a class="anchor" id="ga0739b7c5c51d4dd06d88df8fb562e186"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define DFU_DEVICE_INFO&#160;&#160;&#160;((<a class="el" href="a00404.html">dfu_device_info_t</a> *)<a class="el" href="a01183.html#gacdac816b4730617eedc86394ca32f145">DFU_DEVICE_INFO_BASE</a>)</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>The memory mapped structure for device information data. </p>

</div>
</div>
<a class="anchor" id="gacdac816b4730617eedc86394ca32f145"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define DFU_DEVICE_INFO_BASE</td>
        </tr>
      </table>
</div><div class="memdoc">
<b>Value:</b><div class="fragment"><div class="line">(NRF_UICR_BASE + \</div>
<div class="line">                                             UICR_CUSTOMER_RESERVED_OFFSET + \</div>
<div class="line">                                             UICR_CUSTOMER_DEVICE_INFO_OFFSET)</div>
</div><!-- fragment --><p>The device information base address inside of UICR. </p>

</div>
</div>
<a class="anchor" id="gab5e1b5ab912c1a30149be52c8cea371d"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define DFU_DEVICE_REVISION_EMPTY&#160;&#160;&#160;((uint16_t)0xFFFF)</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Mask indicating no device revision is present in UICR. 0xFFFF is default flash pattern when not written with data. </p>

</div>
</div>
<a class="anchor" id="gaa80004af35800b51c972eb5441641b02"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define DFU_DEVICE_TYPE_EMPTY&#160;&#160;&#160;((uint16_t)0xFFFF)</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Mask indicating no device type is present in UICR. 0xFFFF is default flash pattern when not written with data. </p>

</div>
</div>
<a class="anchor" id="ga963498faf6af23086555c594504b4152"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define DFU_SOFTDEVICE_ANY&#160;&#160;&#160;((uint16_t)0xFFFE)</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Mask indicating that any SoftDevice is allowed for updating this application. Allows for easy development. Not to be used in production images. </p>

</div>
</div>
<a class="anchor" id="ga7dbc00b26886d263bc3ff6fed3314df0"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define UICR_CUSTOMER_DEVICE_INFO_OFFSET&#160;&#160;&#160;0x0</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>The device info offset can be modified to place the device info settings at a different location. If the customer reserved UICR location is used for other application specific data, the offset must be updated to avoid collision with that data.[DFU UICR DEV offset] Device info offset inside the customer UICR reserved area. Customers may change this value to place the device information in a user-preferred location. </p>

</div>
</div>
<a class="anchor" id="gaf398722d5fa37c34e7e1554a4c23b31f"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define UICR_CUSTOMER_RESERVED_OFFSET&#160;&#160;&#160;0x80</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>[DFU UICR DEV offset] Customer reserved area in the UICR. The area from UICR + 0x80 is reserved for customer usage. </p>

</div>
</div>
<h2 class="groupheader">Function Documentation</h2>
<a class="anchor" id="ga1926c2d8e3484641d16f9beb654ac5f1"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint32_t dfu_init_postvalidate </td>
          <td>(</td>
          <td class="paramtype">uint8_t *&#160;</td>
          <td class="paramname"><em>p_image</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint32_t&#160;</td>
          <td class="paramname"><em>image_len</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>DFU postvalidate call for post-checking the received image using the init packet. </p>
<p>Post-validation can verify the integrity check the firmware image received before activating the image. Checks performed can be:</p>
<ul>
<li>A simple CRC as shown in the corresponding implementation of this API in the file dfu_init_template.c</li>
<li>A hash for better verification of the image.</li>
<li>A signature to ensure the image originates from a trusted source. Checks are intended to be expanded for customer-specific requirements.</li>
</ul>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">p_image</td><td>Pointer to the received image. The init data provided in the call <a class="el" href="a01183.html#ga585131c480f3f4e51293e954b4c26aeb">dfu_init_prevalidate</a> will be used for validating the image. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">image_len</td><td>Length of the image data.</td></tr>
  </table>
  </dd>
</dl>
<dl class="retval"><dt>Return values</dt><dd>
  <table class="retval">
    <tr><td class="paramname">NRF_SUCCESS</td><td>If the post-validation succeeded, that meant the integrity of the image has been verified and the image originates from a trusted source (signing). </td></tr>
    <tr><td class="paramname">NRF_ERROR_INVALID_DATA</td><td>If the post-validation failed, that meant the post check of the image failed such as the CRC is not matching the image transfered or the verification of the image fails (signing). </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a class="anchor" id="ga585131c480f3f4e51293e954b4c26aeb"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint32_t dfu_init_prevalidate </td>
          <td>(</td>
          <td class="paramtype">uint8_t *&#160;</td>
          <td class="paramname"><em>p_init_data</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint32_t&#160;</td>
          <td class="paramname"><em>init_data_len</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>DFU prevalidate call for pre-checking the received init packet. </p>
<p>Pre-validation will safety check the firmware image to be transfered in second stage. The function currently checks the device type, device revision, application firmware version, and supported SoftDevices. More checks should be added according to customer-specific requirements.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">p_init_data</td><td>Pointer to the init packet. If the init packet is encrypted or signed, it must first be decrypted before being checked. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">init_data_len</td><td>Length of the init data.</td></tr>
  </table>
  </dd>
</dl>
<dl class="retval"><dt>Return values</dt><dd>
  <table class="retval">
    <tr><td class="paramname">NRF_SUCCESS</td><td>If the pre-validation succeeded, that means the image is supported by the device and it is considered to come from a trusted source (signing). </td></tr>
    <tr><td class="paramname">NRF_ERROR_INVALID_DATA</td><td>If the pre-validation failed, that means the image is not supported by the device or comes from an un-trusted source (signing). </td></tr>
    <tr><td class="paramname">NRF_ERROR_INVALID_LENGTH</td><td>If the size of the init packet is not within the limits of the init packet handler. </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Thu May 7 2015 14:36:38 for nRF51 SDK - S110 SoftDevice by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.3.1 </li>
  </ul>
</div>
</body>
</html>
