<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.3.1"/>
<title>nRF51 SDK - S130 SoftDevice: BLE DFU Service</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="nordic_small.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">nRF51 SDK - S130 SoftDevice
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.3.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Home</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>API&#160;Reference</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('a00107.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">BLE DFU Service </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The Device Firmware Update (DFU) Service exposes necessary information to perform Device Firmware Updates on the device. This service is not a service defined by the <em>Bluetooth</em> SIG, but a proprietary service defined by Nordic Semiconductor to demonstrate a typical Device Firmware Update on an nRF51 device.</p>
<p>The DFU Service does not depend on any other services. Support for the following GATT sub-procedures is mandatory for this service:</p>
<ul>
<li>Write Characteristic Value</li>
<li>Notifications</li>
<li>Read Characteristic Descriptors</li>
<li>Write Characteristic Descriptors</li>
</ul>
<p>The DFU GATT Service can operate only on <em>Bluetooth</em> low energy as transport.</p>
<p>The DFU Service does not define any new error codes for the Attribute Protocol. Data exchange is in little endian (LSB first) order.</p>
<p>This service is instantiated as a primary service in DFU mode.</p>
<h1><a class="anchor" id="ota_spec_number"></a>
Proprietary service UUID</h1>
<p>The assigned service UUID is 0x1531 over proprietary base. See the following table for Nordic Semiconductor's UUID:</p>
<table class="doxtable">
<tr>
<th>Description </th><th>Number base</th></tr>
<tr>
<td>Company identifier: </td><td>0x0059 </td></tr>
<tr>
<td>UUID base: </td><td>0x23, 0xD1, 0xBC, 0xEA, 0x5F, 0x78, 0x23, 0x15, 0xDE, 0xEF, 0x12, 0x12, 0x00, 0x00, 0x00, 0x00 </td></tr>
<tr>
<td>Service UUID start: </td><td>0x1530 </td></tr>
<tr>
<td>Characteristic UUID start: </td><td>0x1531 </td></tr>
</table>
<h1><a class="anchor" id="ota_spec_char"></a>
Service characteristics</h1>
<p>The DFU Service exposes one instance of the characteristics listed in the following table. The service does not impose any security requirements.</p>
<table class="doxtable">
<tr>
<th>Characteristic name </th><th>Requirement </th><th>Mandatory properties </th><th>Description</th></tr>
<tr>
<td>DFU Packet </td><td>M </td><td>WriteWithoutResponse </td><td>See <a class="el" href="a00107.html#ota_spec_dfu_packet">DFU Packet</a>. </td></tr>
<tr>
<td>DFU Control Point </td><td>M </td><td>Write, Notify </td><td>See <a class="el" href="a00107.html#ota_spec_control_state">DFU Control Point</a>. </td></tr>
</table>
<h1><a class="anchor" id="ota_spec_dfu_packet"></a>
DFU Packet</h1>
<p>The UUID of the DFU Packet characteristic is 0x1532 over proprietary base.</p>
<p>This characteristic receives data for Device Firmware Updates as DFU packets. DFU packets can contain different types of data, depending to the Op Code that is written to the DFU Control Point before the DFU packet is transmitted.</p>
<p>The size of each packet must be between 1 and (ATT_MTU - 3) octets. Packets must be in little endian (LSB first) order.</p>
<p>The following table defines the format for a DFU packet:</p>
<table class="doxtable">
<tr>
<th>Names </th><th>Field requirement </th><th>Format </th><th>Additional information</th></tr>
<tr>
<td>DFU Packet </td><td>Mandatory </td><td>uint8 </td><td>This field may be repeated up to a maximum of 20 times, which means that the maximum length of this characteristic is 20 bytes. </td></tr>
</table>
<p>(Minimum and maximum values are not applicable.)</p>
<h2><a class="anchor" id="bledfu_bleservice_size"></a>
Image size</h2>
<p>After writing "Start DFU" (0x01) to the DFU Control Point, you must write the image size to the DFU Packet characteristic.</p>
<p>The image size must be written in the following format: </p>
<div class="fragment"><div class="line">&lt;Length of SoftDevice&gt;&lt;Length of bootloader&gt;&lt;Length of application&gt;</div>
</div><!-- fragment --><p> All lengths must be uint32. If a length is not present (for example, if only the SoftDevice is updated), the length should be given as 0. For example: </p>
<div class="fragment"><div class="line">&lt;Length of SoftDevice&gt; 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00</div>
</div><!-- fragment --><h2><a class="anchor" id="bledfu_bleservice_init"></a>
Init packet</h2>
<p>After writing "Initialize DFU Parameters" (0x02) to the DFU Control Point, you must write an init packet to the DFU Packet characteristic.</p>
<p>See <a class="el" href="a00101.html">Safety-checking the image</a> for information about the format of the init packet.</p>
<h2><a class="anchor" id="bledfu_bleservice_data"></a>
Image data</h2>
<p>After writing "Receive Firmware Image" (0x03) to the DFU Control Point, you must write packets containing image data to the DFU Packet characteristic.</p>
<p>The firmware image can be split up in multiple DFU packets. The full image is transferred by writing each fragment as DFU packet to the DFU Packet characteristic.</p>
<h1><a class="anchor" id="ota_spec_control_state"></a>
DFU Control Point</h1>
<p>The UUID of the DFU Control Point characteristic is 0x1531 over proprietary base.</p>
<p>The DFU Control Point characteristic is used to control the state of the Device Firmware Update process. All DFU procedures are requested by writing to this characteristic. A response that marks the end of the procedure is received as a notification.</p>
<p>The following table shows control point procedure operation codes and the respective parameters:</p>
<table class="doxtable">
<tr style="font-size:smaller">
<th>Names</th><th>Field requirement</th><th>Format</th><th>Additional information  </th></tr>
<tr style="font-size:smaller">
<td>Op Code </td><td>Mandatory </td><td>uint8 </td><td>Enumerations: <table class="doxtable">
<tr style="font-size:smaller">
<th>Key</th><th>Value</th><th>Requirement</th><th>Description </th></tr>
<tr style="font-size:smaller">
<td>0</td><td>Reserved for future use</td><td></td><td></td></tr>
<tr style="font-size:smaller">
<td>1</td><td>Start DFU</td><td>C4</td><td>Initiate the firmware update procedure. The response to this Op Code is a notification of the control point with Op Code 0x10, followed by the request Op Code 0x01 and the appropriate Response Value. </td></tr>
<tr style="font-size:smaller">
<td>2</td><td>Initialize DFU Parameters</td><td>C5</td><td>Prepare to receive init packets. The response to this Op Code is a notification of the control point with Op Code 0x10, followed by the request Op Code 0x02 and the appropriate Response Value. </td></tr>
<tr style="font-size:smaller">
<td>3</td><td>Receive Firmware Image</td><td></td><td>Prepare to receive the firmware data. The response to this Op Code is a notification of the control point with Op Code 0x10, followed by the request Op Code 0x03 and the appropriate Response Value. </td></tr>
<tr style="font-size:smaller">
<td>4</td><td>Validate Firmware</td><td></td><td>Validate the received firmware. The response to this Op Code is a notification of the control point with Op Code 0x10, followed by the appropriate Response Value. </td></tr>
<tr style="font-size:smaller">
<td>5</td><td>Activate Image and Reset</td><td></td><td>Activate the previously received image and perform a system reset. There is no response to this Op Code. </td></tr>
<tr style="font-size:smaller">
<td>6</td><td>Reset System</td><td></td><td>Perform a system reset. There is no response to this Op Code. </td></tr>
<tr style="font-size:smaller">
<td>7</td><td>Report Received Image Size</td><td></td><td>Request the DFU target to report the total number of bytes of firmware data received (excluding the start data and init data). The response to this Op Code is a notification of the control point with Op Code 0x10, followed by the request Op Code 0x07, the appropriate Response Value, and the number of bytes in the Response Parameter. </td></tr>
<tr style="font-size:smaller">
<td>8</td><td>Packet Receipt Notification Request</td><td>C1</td><td>Request the DFU target to enable/disable notifications of the control point characteristic each time the specified number of packets containing firmware data has been received. There is no response to this Op Code. </td></tr>
<tr style="font-size:smaller">
<td>16</td><td>Response Code</td><td>C2</td><td>The Response Code is followed by the Request Op Code, the Response Value, and optionally the Response Parameter. </td></tr>
<tr style="font-size:smaller">
<td>17</td><td>Packet Receipt Notification</td><td>C3</td><td>A notification sent by the DFU target indicating that a new set of the preconfigured number of firmware data packets has been received. </td></tr>
<tr style="font-size:smaller">
<td>9-15</td><td>Reserved for future use</td><td></td><td></td></tr>
<tr style="font-size:smaller">
<td>18-255</td><td>Reserved for future use</td><td></td><td></td></tr>
</table>
</td></tr>
<tr style="font-size:smaller">
<td>Number of Packets<br/>
<b>Information:</b> Parameter value for the Packet Receipt Notification Request Op Code </td><td>C1 </td><td>uint16 </td><td>Number of packets of firmware data to be received by the DFU target before sending a new Packet Receipt Notification (control point notification with Op Code = 7). If this value is 0, the packet receipt notification will be disabled by the DFU target.  </td></tr>
<tr style="font-size:smaller">
<td>Request Op Code<br/>
<b>Information:</b> Parameter value for the Response Code Op Code </td><td>C2 </td><td>uint8 </td><td>Refer to the Op Code table above for additional information on the possible values for this field.  </td></tr>
<tr style="font-size:smaller">
<td>Response Value<br/>
<b>Information:</b> C2: This field is mandatory for the Response Code Op Code. Otherwise, this field is excluded. </td><td>C2 </td><td>uint8 </td><td>Enumerations: <table class="doxtable">
<tr style="font-size:smaller">
<th>Key</th><th>Value</th><th>Description </th></tr>
<tr style="font-size:smaller">
<td>0</td><td>Reserved for future use</td><td></td></tr>
<tr style="font-size:smaller">
<td>1</td><td>Success</td><td>Response for successful operation. </td></tr>
<tr style="font-size:smaller">
<td>2</td><td>Invalid State</td><td>The DFU controller has performed an operation that is not valid in the current state of the firmware update process. </td></tr>
<tr style="font-size:smaller">
<td>3</td><td>Not Supported</td><td>The previous operation performed by the DFU controller or the data sent by the DFU controller is not supported. </td></tr>
<tr style="font-size:smaller">
<td>4</td><td>Data Size Exceeds Limit</td><td>The DFU controller is trying to send more firmware data than expected. </td></tr>
<tr style="font-size:smaller">
<td>5</td><td>CRC Error</td><td>A CRC error has occurred. This Response Value is used only by the Validate Firmware procedure. </td></tr>
<tr style="font-size:smaller">
<td>6</td><td>Operation Failed</td><td>Response if the requested procedure failed. </td></tr>
<tr style="font-size:smaller">
<td>7-255</td><td>Reserved for future use</td><td></td></tr>
</table>
</td></tr>
<tr style="font-size:smaller">
<td>Response Parameter<br/>
<b>Information:</b> C2: This field is optional for the Response Code Op Code. Otherwise, this field is excluded. </td><td>C2 </td><td>variable </td><td>Note: The Response Parameter of the response to the control point is a variable length field to allow a list of different values defined by the service specification.  </td></tr>
<tr style="font-size:smaller">
<td>Number of Bytes of Firmware Image Received<br/>
<b>Information:</b> C3: This field is present if the Op Code is 0x11 (Packet Receipt Notification). </td><td>C3 </td><td>uint32 </td><td>Number of bytes of firmware data (excluding the start and init data) received by the DFU target at the given point of time.  </td></tr>
<tr style="font-size:smaller">
<td>DFU Image Type<br/>
<b>Information:</b> C4: This field is present if the Op Code is 0x01 (Start DFU). This field is parsed as bit field where each bit that is set indicates the image transferred for the requested DFU. </td><td>C4 </td><td>uint8 </td><td>Enumerations: <table class="doxtable">
<tr style="font-size:smaller">
<th>Key</th><th>Value</th><th>Description </th></tr>
<tr style="font-size:smaller">
<td>0x00</td><td>No Image</td><td>No image will be updated. </td></tr>
<tr style="font-size:smaller">
<td>0x01</td><td>SoftDevice</td><td>A SoftDevice image will be transferred. </td></tr>
<tr style="font-size:smaller">
<td>0x02</td><td>Bootloader</td><td>A bootloader image will be transferred. </td></tr>
<tr style="font-size:smaller">
<td>0x03</td><td>SoftDevice Bootloader</td><td>A SoftDevice with Bootloader image will be transferred. </td></tr>
<tr style="font-size:smaller">
<td>0x04</td><td>Application</td><td>An application image will be transferred. </td></tr>
<tr style="font-size:smaller">
<td>0x05-0x07</td><td>Other image combinations</td><td>Currently not supported. </td></tr>
<tr style="font-size:smaller">
<td>0x08-0xFF</td><td>Reserved for future use</td><td></td></tr>
</table>
</td></tr>
<tr style="font-size:smaller">
<td>DFU Init Packet<br/>
<b>Information:</b> C5: This field is present if the Op Code is 0x02 (Initialize DFU Parameters).  </td><td>C5 </td><td>uint8 </td><td>Enumerations: <table class="doxtable">
<tr style="font-size:smaller">
<th>Key</th><th>Value</th><th>Description </th></tr>
<tr style="font-size:smaller">
<td>0x00</td><td>Receive Init Packet</td><td>Ready to receive the DFU init packet. </td></tr>
<tr style="font-size:smaller">
<td>0x01</td><td>Init Packet Complete</td><td>Transmission of the DFU init packet is complete. </td></tr>
</table>
</td></tr>
</table>
<div style="font-size:smaller">(Minimum and maximum values are not applicable.)</div><h1><a class="anchor" id="ota_spec_control_point_err_handling"></a>
General error handling procedures</h1>
<p>If an Op Code is written to the DFU Control Point characteristic and the Client Characteristic Configuration Descriptors of either or both of the DFU Control Point or the DFU Status Report are not configured for notifications, the DFU target will return an error response. The Attribute Protocol Application error code of this response will be set to "Client Characteristic Configuration Descriptor Improperly Configured" (as defined in CSS Part B, Section 1.2 of Supplement to the <em>Bluetooth</em> Core Specification, Version 3 or later). </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="a00004.html">Examples</a></li><li class="navelem"><a class="el" href="a00086.html">BLE DFU Bootloader</a></li><li class="navelem"><a class="el" href="a00105.html">Transport layers</a></li>
    <li class="footer">Generated on Thu May 7 2015 14:37:01 for nRF51 SDK - S130 SoftDevice by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.3.1 </li>
  </ul>
</div>
</body>
</html>
