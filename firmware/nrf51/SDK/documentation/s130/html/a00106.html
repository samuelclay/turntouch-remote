<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.3.1"/>
<title>nRF51 SDK - S130 SoftDevice: BLE DFU Profile</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="nordic_small.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">nRF51 SDK - S130 SoftDevice
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.3.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Home</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>API&#160;Reference</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('a00106.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">BLE DFU Profile </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The Device Firmware Update (DFU) Profile is an example for a proprietary profile that can be used to update firmware files using <em>Bluetooth</em> low energy. This profile is not a standard profile. It is defined by Nordic Semiconductor to demonstrate how a typical Device Firmware Update can be achieved.</p>
<p>The DFU Profile is used to transfer application, SoftDevice, or bootloader images from a BLE central (for example, a computer or a smartphone) to a peripheral (for example, a Heart Rate Sensor) that supports Device Firmware Updates using the DFU Service.</p>
<p><b>Profile dependencies</b>: This profile requires the Generic Attribute Profile (GATT).</p>
<h1><a class="anchor" id="ota_profile_conf"></a>
Configuration</h1>
<h2><a class="anchor" id="ota_profile_roles"></a>
Roles</h2>
<p>The profile defines two roles: DFU target and client (also referred to as DFU controller).</p>
<ul>
<li>The DFU target implements a GATT Server. This is the device that is updated by the DFU controller.</li>
<li>The DFU controller implements a GATT client. This is the device that uploads a new firmware image to the DFU target.</li>
</ul>
<h2><a class="anchor" id="ota_profile_role_service"></a>
Role/service relationships</h2>
<p>The following diagram shows the relationships between services and the two profile roles.</p>
<div class="image">
<img src="ota_roles_overview.svg" alt="ota_roles_overview.svg"/>
<div class="caption">
Relationship between profile roles and services</div></div>
<p> A DFU target instantiates one instance of the DFU Service.</p>
<h1><a class="anchor" id="ota_profile_updater_role_req"></a>
DFU controller role requirements</h1>
<p>The DFU controller shall support the <a class="el" href="a00107.html">BLE DFU Service</a>.</p>
<table class="doxtable">
<tr>
<th>Service </th><th>DFU controller</th></tr>
<tr>
<td>Device Firmware Update Service </td><td>M </td></tr>
</table>
<h2><a class="anchor" id="ota_profile_dfu_controller_err_handling"></a>
General error handling</h2>
<p>The DFU controller shall be tolerant when receiving the following ATT Error Code defined in CSS Part B, Section 1.2 of Supplement to the <em>Bluetooth</em> Core Specification, Version 3 or later:</p>
<ul>
<li>Client Characteristic Configuration Descriptor Improperly Configured</li>
</ul>
<h2><a class="anchor" id="ota_profile_updater_role_transfering"></a>
DFU image transfer procedure</h2>
<p>The DFU controller requests one of the procedures that are defined for a Device Firmware Update using the <em>DFU Control Point</em>. Each procedure requested by the controller is characterized by a request on the DFU Control Point, using the GATT Write procedure. This procedure may be followed by additional writes on the <em>DFU Packet</em> characteristic. The request to activate the image and reset the device ends the procedure. The DFU target for the procedure responds to this request using GATT notifications on the control point. The response code in the response packet contains information about the success or failure of the procedure. In case of failure, the response code provides an indication on the possible reason for the failure. See <a class="el" href="a00107.html#ota_spec_control_state">DFU Control Point</a> for more details.</p>
<p>The DFU target processes one request at a time. Therefore, if a request is received on the target while it is already processing another request, an ATT error response ("Procedure Already In Progress") is received on the DFU controller. Asynchronous status information and information about the size of the received image is sent by the DFU target as GATT notifications on the control point.</p>
<p>The following message sequence chart shows a typical DFU Control Point procedure:</p>
<div class="image">
<img src="ota_dfu_typical_ctrl_pt_procedure.svg" alt="ota_dfu_typical_ctrl_pt_procedure.svg"/>
<div class="caption">
Typical DFU Control Point procedure</div></div>
<p> All defined DFU procedures are listed below:</p>
<table class="doxtable">
<tr>
<th>DFU procedure </th><th>Description</th></tr>
<tr>
<td>Start DFU </td><td>Procedure to prepare the device for uploading the firmware. The size of the firmware image is provided in the request parameter. The response of the DFU target indicates if the device is ready for the next stage of the firmware update. The Start DFU procedure must be followed by a byte indicating the type of update. </td></tr>
<tr>
<td>Receive Init Data </td><td>Procedure to exchange information that must be exchanged before uploading the new firmware. Such information includes the device type, the revision type, the application version, hashs/public keys, and so on. See <a class="el" href="a00101.html">Safety-checking the image</a> for more information. </td></tr>
<tr>
<td>Receive Image Data </td><td>Procedure to upload firmware, fragmented into DFU packets. The maximum size of each packet is (ATT_MTU - 3) octets. DFU packets can be of variable length with a minimum size of 1 octet; the length must be a multiple of the word size. The firmware is expected in binary format. </td></tr>
<tr>
<td>Validate </td><td>Procedure to validate the updated firmware image. The current implementation supports only CRC validation in addition to size validation (which is always performed). CRC validation is optional and uses the information provided in the Receive Init Data procedure. </td></tr>
<tr>
<td>Activate Image &amp; Reset </td><td>Procedure to activate the new firmware and restart the device with the new firmware. This procedure results in a GAP Disconnect. </td></tr>
<tr>
<td>System Reset </td><td>Procedure to reset the system. This procedure result in a GAP Disconnect. This procedure can be requested at any stage. The system will then restart with the old application if the device had an existing application. Otherwise, the system will restart in DFU mode. </td></tr>
<tr>
<td>Report Received Image Size </td><td>Procedure to request the size of the received image. This procedure is particularly useful on reconnection after a link loss. See <a class="el" href="a00106.html#ota_profile_ll_behavior">Link loss procedure</a> for more information. </td></tr>
<tr>
<td>Packet Receipt Notification</td><td>Procedure to request notifications every time after receiving a certain number of packets. The number of packets is specified in the request by the controller. This procedure is not mandatory. </td></tr>
</table>
<p>See <a class="el" href="a00107.html#ota_spec_control_state">DFU Control Point</a> for more information about the procedures.</p>
<p>When the DFU target is in DFU mode, it is in <em>GAP General Discoverable mode</em> and is <em>connectable</em>. The 128-bit DFU Service UUID is advertised in the advertisement data, along with the full name (DfuTarg). When the DFU target is connected to the DFU controller, the DFU process can be started by requesting a Start DFU procedure.</p>
<p>The following message sequence chart shows a typical firmware update exchange between a DFU controller and a DFU target:</p>
<div class="image">
<img src="exp_ota_dfu_transfer.svg" alt="exp_ota_dfu_transfer.svg"/>
<div class="caption">
Transfer of an image to the DFU target</div></div>
 <h2><a class="anchor" id="ota_idle_mode_procedure"></a>
Idle mode procedure</h2>
<p>If no connection is established with the DFU target after 60 seconds, the target device will restart in normal mode with the old application if the device had an existing application. Otherwise, the system will restart in DFU mode.</p>
<h2><a class="anchor" id="ota_image_validation_procedure"></a>
Image validation procedure</h2>
<p>The post-validate function <a class="el" href="a01158.html#ga1926c2d8e3484641d16f9beb654ac5f1">dfu_init_postvalidate</a> in <code>dfu_init_template</code> validates the updated firmware image.</p>
<h2><a class="anchor" id="ota_profile_idle_conn"></a>
Idle connection procedure</h2>
<p>When the bootloader example application detects that the connection has been idle for a certain period, thus if the DFU controller has not written any packets to continue the firmware update, the update is stopped. The connection is terminated and the previously valid application is started. If there is no valid application, the device remains in bootloader mode and waits for a reconnection from the DFU controller.</p>
<h2><a class="anchor" id="ota_profile_ll_behavior"></a>
Link loss procedure</h2>
<p>When the bootloader example application detects a link loss, the DFU state and image size is stored. When the controller connects again, the transfer can resume from where it stopped. The controller can request information about the size of the received image using the Report Received Image Size procedure and start thetransfer by applying the necessary offset. In the disconnected state after a link loss, the <a class="el" href="a00106.html#ota_idle_mode_procedure">Idle mode procedure</a> applies.</p>
<p>The following message sequence chart shows a typical link loss recovery procedure:</p>
<div class="image">
<img src="exp_dfu_ota_link_loss.svg" alt="exp_dfu_ota_link_loss.svg"/>
<div class="caption">
Recovery after link loss</div></div>
 <h2><a class="anchor" id="ota_profile_pkt_rcpt_notif"></a>
Packet Receipt Notification procedure</h2>
<p>The DFU controller can subscribe to notifications from the DFU target, to be notified every time a given number of firmware packets has been received. To enable such notifications, the DFU controller must write the Op Code 0x08 (Packet Receipt Notification Request) followed by the number of packets to the DFU Control Point. The DFU target will then send a notification of the DFU Control Point with Op Code 0x11 (Packet Receipt Notification) every time the specified number of firmware packets has been received. The DFU controller should wait for this notification every time after sending the specified number of firmware packets.</p>
<p>As part of the packet receipt notification, the DFU target also sends the total number of bytes of firmware data received so far. This information can be used for consistency checks by the DFU controller.</p>
<p>The following message sequence chart shows a typical Packet Receipt Notification procedure:</p>
<div class="image">
<img src="exp_dfu_ota_pkt_rcpt_notif_procedure.svg" alt="exp_dfu_ota_pkt_rcpt_notif_procedure.svg"/>
<div class="caption">
Packet Receipt Notification procedure</div></div>
 <h1><a class="anchor" id="security_considerations"></a>
Security considerations</h1>
<p>All supported characteristics specified by the DFU Service on the target are set to Security Mode 1 and Security Level 1. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="a00004.html">Examples</a></li><li class="navelem"><a class="el" href="a00086.html">BLE DFU Bootloader</a></li><li class="navelem"><a class="el" href="a00105.html">Transport layers</a></li>
    <li class="footer">Generated on Thu May 7 2015 14:37:01 for nRF51 SDK - S130 SoftDevice by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.3.1 </li>
  </ul>
</div>
</body>
</html>
